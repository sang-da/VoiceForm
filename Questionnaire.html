<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link id="favicon" rel="icon" href="./assets/favicon.png">

  <!-- =================================================================================== -->
  <!-- =========================== CONFIGURATION DE L'APPLICATION ====================== -->
  <!-- =================================================================================== -->
  <script id="app-config">
    /*
     * Configurez votre application ici.
     */
    window.APP_CONFIG = {
      // --- Backend URL ---
      // !! REMPLACEZ CECI par l'URL de votre Google Apps Script d√©ploy√© !!
      WEBAPP_URL: "REMPLACEZ_PAR_VOTRE_URL_DE_WEBAPP_GOOGLE_SCRIPT",

      // --- Branding ---
      BRAND: {
        TITLE: "Feedback App (Mod√®le)", 
        LOGO_URL: "https://placehold.co/120x40/f0f0f0/333?text=Logo",
        MARK_URL: "https://placehold.co/20x20/4f46e5/ffffff?text=F",
        FAVICON_URL: "https://placehold.co/32x32/4f46e5/ffffff?text=F"
      },

      // --- Limites d'enregistrement ---
      LIMITS: {
        MAX_SECONDS: 120, // 2 minutes
        MAX_BYTES: 10 * 1024 * 1024, // 10MB
      },

      // --- Questions (√Ä personnaliser) ---
      QUESTIONS: {
        etudiant: { declic: "En tant qu'√©tudiant, quel a √©t√© le 'd√©clic' ou le moment 'aha' o√π vous avez saisi l'utilit√© de ce projet ?", usage: "Comment avez-vous concr√®tement utilis√© ce projet ?", clarte: "Qu'est-ce qui a le plus clarifi√© votre compr√©hension du framework ? (ex: un cours, un exemple...)", equipe: "Si vous l'avez utilis√© en groupe, comment ce projet a-t-il structur√© vos √©changes ?", CHOPi: "Dans votre parcours d'apprentissage, qu'est-ce qui vous a plu ou manqu√© dans l'outil ?", reutilisation: "Pensez-vous r√©utiliser ce code √† l'avenir ? Si oui, dans quel type de projet ou de contexte ?", libre: "Vous avez la parole : quel est le retour le plus important que vous aimeriez nous donner ?" },
        enseignant: { declic: "En tant qu'enseignant, quel 'd√©clic' p√©dagogique avez-vous eu en d√©couvrant ce projet ?", usage: "Comment avez-vous concr√®tement utilis√© ce projet dans un de vos cours ou ateliers ?", clarte: "Du point de vue de l'enseignant, qu'est-ce qui vous semble le plus efficace pour transmettre ce framework aux √©tudiants ?", equipe: "Comment vos √©tudiants ont-ils r√©agi √† la m√©thode ? Qu'est-ce qui a bien fonctionn√© ou non en classe ?", CHOPi: "Qu'avez-vous pens√© de cet outil comme support p√©dagogique ? Que lui manque-t-il ?", reutilisation: "Pensez-vous r√©utiliser ce projet dans votre programme de cours √† l'avenir ? Si oui, comment ?", libre: "Vous avez la parole : quel est le retour p√©dagogique le plus important que vous aimeriez nous donner ?" },
        autre: { declic: "Dans votre contexte particulier, quel a √©t√© le 'd√©clic' ou le moment 'aha' o√π vous avez saisi l'utilit√© de ce projet ?", usage: "Comment avez-vous concr√®tement utilis√© ce projet ?", clarte: "Qu'est-ce qui a le plus clarifi√© votre compr√©hension du framework ?", equipe: "Si vous l'avez utilis√© en groupe, comment ce projet a-t-il structur√© vos √©changes ?", CHOPi: "Dans votre situation, qu'est-ce qui vous a plu ou manqu√© dans l'outil ?", reutilisation: "Pensez-vous r√©utiliser ce projet √† l'avenir ? Si oui, dans quel type de projet ou de contexte ?", libre: "Vous avez la parole : quel est le retour le plus important que vous aimeriez nous donner ?" }
      }
    };
  </script>
  <title id="appTitle">Feedback App</title>
  <meta name="description" content="Collecte s√©curis√©e de retours vocaux.">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg-start: #f3f4f6; --bg-end: #e0e7ff; --bg-mid: #dbeafe; --card-bg: rgba(255, 255, 255, 0.45); --card-border: rgba(255, 255, 255, 0.7); --card-shadow: rgba(0, 0, 0, 0.05); --text-primary: #111827; --text-secondary: #4b5563; --accent-primary: #4f46e5; --accent-primary-hover: #4338ca; --accent-success: #16a34a; --accent-record: #dc2626; --accent-pause: #f59e0b; }
    body { background: linear-gradient(-45deg, var(--bg-start), var(--bg-mid), var(--bg-end), var(--bg-mid)); background-size: 400% 400%; animation: gradientBG 25s ease infinite; color: var(--text-primary); padding-bottom: 80px; font-family: Inter, sans-serif; }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .glass-bubble { background-color: var(--card-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--card-border); box-shadow: 0 8px 32px 0 var(--card-shadow); transition: all 0.3s ease; border-radius: 1rem; }
    .form-input { background-color: rgba(255, 255, 255, 0.6); border: 1px solid rgba(209, 213, 219, 0.8); color: var(--text-primary); border-radius: 0.5rem; }
    .form-input:focus { background-color: rgba(255, 255, 255, 0.9); border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--accent-primary); outline: none; }
    .btn-disabled { opacity: 0.5; cursor: not-allowed; }
    #floatingProgress { background-color: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid var(--card-border); transition: opacity 0.3s, transform 0.3s; z-index: 60; border-top-left-radius: 1rem; border-top-right-radius: 1rem;}
    .progress-bar-inner { background: linear-gradient(90deg, var(--accent-primary), var(--accent-success)); background-size: 200% 100%; animation: progress-active 2s ease-in-out infinite; transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1); border-radius: 9999px;}
    @keyframes progress-active { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
    .hidden { display: none; }
    #profileModal, #completionModal { align-items: flex-start; padding-top: 1rem; padding-bottom: 1rem; }
    @media (min-width: 640px) { #profileModal, #completionModal { align-items: center; } }
    #profileModal .glass-bubble, #completionModal .glass-bubble { overflow-y: auto; max-height: 90vh; }
    #profileModal form { overflow-y: visible; padding-bottom: 0; flex-grow: 0; }
    .modal-footer { padding-top: 1rem; text-align: right; }
    .modal-footer.flex { display: flex; align-items: center; justify-content: flex-end; gap: 0.75rem; }
    #toasts { z-index: 70; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    .border-b-2 { border-bottom-width: 2px; }
    .border-indigo-600 { border-color: #4f46e5; }
    .h-5 { height: 1.25rem; } .w-5 { width: 1.25rem; }
    .btn { padding-left: 1.25rem; padding-right: 1.25rem; padding-top: 0.5rem; padding-bottom: 0.5rem; font-weight: 600; border-radius: 9999px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; outline: 2px solid transparent; outline-offset: 2px; }
    .btn:focus-visible { box-shadow: 0 0 0 2px var(--card-border), 0 0 0 4px var(--accent-primary); }
    .btn-primary { background-color: var(--accent-primary); color: white; } .btn-primary:hover { background-color: var(--accent-primary-hover); } .btn-primary:focus-visible { box-shadow: 0 0 0 2px var(--card-border), 0 0 0 4px var(--accent-primary); }
    .btn-secondary { background-color: white; color: var(--accent-primary); border: 1px solid #e5e7eb; } .btn-secondary:hover { background-color: #f9fafb; } .btn-secondary:focus-visible { box-shadow: 0 0 0 2px var(--card-border), 0 0 0 4px var(--accent-primary); }
    .btn-record { background-color: var(--accent-record); color: white; } .btn-record:hover { background-color: #b91c1c; } .btn-record:focus-visible { box-shadow: 0 0 0 2px var(--card-border), 0 0 0 4px var(--accent-record); }
    .btn-pause { background-color: var(--accent-pause); color: white; } .btn-pause:hover { background-color: #d97706; } .btn-pause:focus-visible { box-shadow: 0 0 0 2px var(--card-border), 0 0 0 4px var(--accent-pause); }
    .btn-sm { padding-left: 0.75rem; padding-right: 0.75rem; padding-top: 0.25rem; padding-bottom: 0.25rem; font-size: 0.875rem; }
    .btn-icon { padding: 0.5rem; }
  </style>
</head>
<body class="min-h-screen antialiased">

  <header class="max-w-5xl mx-auto px-4 pt-6 pb-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
          <img id="brandLogo" src="https://placehold.co/120x40/f0f0f0/333?text=Logo" alt="Logo" class="h-10 w-auto">
          <h1 id="brandTitle" class="text-xl font-semibold text-gray-800 hidden sm:block"></h1>
      </div>
      <button id="editProfileBtn" class="hidden text-sm font-medium text-indigo-600 hover:text-indigo-800">
          Modifier le profil
      </button>
  </header>

  <main id="mainContent" class="max-w-5xl mx-auto p-4 space-y-6 opacity-0 transition-opacity duration-500">
      <div id="cardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
          <!-- Les cartes de questions seront inject√©es ici -->
      </div>
  </main>

  <div id="floatingProgress" class="fixed bottom-0 left-0 right-0 p-4 shadow-lg">
      <div class="max-w-5xl mx-auto">
          <div class="flex items-center justify-between mb-1">
              <p id="progressText" class="text-sm font-medium text-gray-700" aria-live="polite">0/0 compl√©t√©es</p>
              <span id="progressPct" class="text-sm font-semibold text-indigo-600">0%</span>
          </div>
          <div class="w-full h-2 rounded-full bg-gray-200 overflow-hidden">
              <div id="progressBar" class="progress-bar-inner h-2 rounded-full" style="width:0%"></div>
          </div>
      </div>
  </div>

  <div id="toasts" aria-live="polite" class="fixed top-5 right-5 z-50 w-full max-w-xs space-y-3"></div>

  <!-- MODALE PROFIL -->
   <div id="profileModal" class="fixed inset-0 z-40 flex items-start sm:items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="profileModalTitle">
     <div class="fixed inset-0 bg-gray-900/30 backdrop-blur-sm" aria-hidden="true"></div>
     <div class="glass-bubble relative w-full max-w-2xl p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
       <h2 id="profileModalTitle" class="text-2xl font-bold text-gray-900 mb-2">Vos informations</h2>
       <p class="text-sm text-gray-600 mb-6">Pour personnaliser les questions.</p>
       <form id="metaForm" class="space-y-5" novalidate>
         <fieldset class="grid grid-cols-1 sm:grid-cols-2 gap-4"> <div> <label for="studentCode" class="block text-sm font-medium">Identifiant</label> <input id="studentCode" name="studentCode" placeholder="ID_Exemple" class="form-input mt-1 w-full px-3 py-2" required maxlength="32" inputmode="text" pattern="[A-Za-z0-9_\-]+"> <p class="mt-1 text-xs text-gray-500">Ex: ID √©tudiant, pseudo...</p> </div> <div> <label for="cohort" class="block text-sm font-medium">Contexte</label> <input id="cohort" name="cohort" placeholder="Ex : M2 Info, Projet Y..." class="form-input mt-1 w-full px-3 py-2" required> <p class="mt-1 text-xs text-gray-500">Promo, entreprise, √©tablissement...</p> </div> <div> <label for="profile" class="block text-sm font-medium">Profil</label> <select id="profile" name="profile" class="form-input mt-1 w-full px-3 py-2 appearance-none"> <option value="etudiant" selected>√âtudiant</option> <option value="enseignant">Enseignant</option> <option value="autre">Autre</option> </select> </div> <div> <label for="used" class="block text-sm font-medium">Usage du Projet</label> <select id="used" name="used" class="form-input mt-1 w-full px-3 py-2 appearance-none"> <option value="TestProjet">Test du projet</option> <option value="Inspiration">Inspiration code</option> <option value="Autre">Autre</option> </select> </div> </fieldset>
         <fieldset class="space-y-3 pt-2"> <legend class="text-sm font-medium">Consentement</legend> <label class="flex items-start gap-3 p-3 rounded-lg bg-white/50 border border-white/80 cursor-pointer"> <input id="consent" type="checkbox" class="mt-1 h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300"> <span class="text-sm text-gray-700">J‚Äôaccepte le stockage (audio + transcript) et l‚Äôusage anonymis√© de ces donn√©es. Suppression possible sur demande.</span> </label> </fieldset>

         <div class="modal-footer flex">
             <div id="profileSpinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-600"></div>
             <button id="saveProfileBtn" type="submit" class="btn btn-primary">
               Valider et commencer
             </button>
         </div>
       </form>
     </div>
   </div>

  <!-- MODALE ENREGISTREMENT -->
  <div id="recordModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="fixed inset-0 bg-gray-900/30 backdrop-blur-sm" aria-hidden="true"></div>
    <div class="glass-bubble relative w-full max-w-xl shadow-xl">
      <div class="flex items-start justify-between p-4 border-b border-white/50">
          <div> <p id="modalTheme" class="text-xs uppercase tracking-wide font-semibold text-indigo-700"></p> <h3 id="modalTitle" class="text-lg font-semibold text-gray-900"></h3> </div>
          <button id="modalClose" class="btn btn-secondary btn-icon" aria-label="Fermer"> <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button>
      </div>
      <div class="p-4 sm:p-6 space-y-5">
          <div id="controlsWrap" class="flex flex-col sm:flex-row items-center gap-3">
              <button id="btnRecord" type="button" class="btn btn-record w-full sm:w-auto"> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 8.5a.5.5 0 011 0V10a2 2 0 104 0V8.5a.5.5 0 011 0v1.5a3 3 0 11-6 0V8.5z" /><path d="M9 14a1 1 0 001 1h0a1 1 0 001-1v-1a1 1 0 00-1-1h0a1 1 0 00-1 1v1z" /></svg> Enregistrer </span> </button>
              <button id="btnPause" type="button" class="btn btn-pause w-full sm:w-auto hidden"> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.5 3.5A1.5 1.5 0 017 5v10a1.5 1.5 0 01-3 0V5a1.5 1.5 0 011.5-1.5zM12.5 3.5A1.5 1.5 0 0114 5v10a1.5 1.5 0 01-3 0V5a1.5 1.5 0 011.5-1.5z" clip-rule="evenodd" /></svg> Pause </span> </button>
              <button id="btnResume" type="button" class="btn btn-record w-full sm:w-auto hidden"> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 8.5a.5.5 0 011 0V10a2 2 0 104 0V8.5a.5.5 0 011 0v1.5a3 3 0 11-6 0V8.5z" /><path d="M9 14a1 1 0 001 1h0a1 1 0 001-1v-1a1 1 0 00-1-1h0a1 1 0 00-1 1v1z" /></svg> Reprendre </span> </button>
              <button id="btnStop" type="button" class="btn btn-secondary w-full sm:w-auto hidden" disabled> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 3.5A1.5 1.5 0 016.5 2h7A1.5 1.5 0 0115 3.5v7a1.5 1.5 0 01-1.5 1.5h-7A1.5 1.5 0 015 10.5v-7z" clip-rule="evenodd" /></svg> Stop </span> </button>
              <div class="flex-1 w-full pt-2 sm:pt-0"> <div class="h-2 rounded-full bg-white/60 overflow-hidden"><div id="meter" class="h-2 bg-green-500 transition-all duration-75 rounded-full" style="width:0%"></div></div> <p id="timerWrap" class="mt-1 text-xs text-gray-600 text-right"><span id="timer">00:00</span> / 00:00</p> </div>
          </div>
          <div id="previewWrap" class="hidden space-y-4">
              <button id="btnReRecord" type="button" class="btn btn-secondary btn-sm"> ‚Ü∫ R√©enregistrer </button>
              <audio id="player" controls controlsList="nodownload noplaybackrate" class="w-full rounded-full"></audio>
              <p id="fileInfo" class="mt-1 text-xs text-gray-500"></p>
          </div>
      </div>
      <div class="p-4 border-t border-white/50 flex items-center justify-between">
          <p class="text-xs text-gray-500">√âtat : <span id="status">Pr√™t</span></p>
          <button id="btnSend" class="btn btn-primary btn-disabled" disabled> Envoyer cette r√©ponse </button>
      </div>
    </div>
  </div>
  
  <!-- MODALE DE F√âLICITATIONS -->
  <div id="completionModal" class="fixed inset-0 z-50 flex items-start sm:items-center justify-center p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="completionModalTitle">
    <div class="fixed inset-0 bg-gray-900/30 backdrop-blur-sm" aria-hidden="true"></div>
    <div class="glass-bubble relative w-full max-w-lg p-6 sm:p-8 max-h-[90vh] overflow-y-auto text-center">
      <h2 id="completionModalTitle" class="text-3xl font-bold text-gray-900 mb-3">üéâ F√©licitations !</h2>
      <p class="text-base text-gray-700 mb-6">
        Vous avez compl√©t√© tous les feedbacks. Merci infiniment pour votre contribution pr√©cieuse !
      </p>
      
      <!-- Bandeau Email -->
      <div class="p-4 rounded-lg bg-white/50 border border-white/80 text-left space-y-2">
         <label for="userEmail" class="block text-sm font-medium text-gray-800">Laissez-nous votre email pour un suivi (optionnel) :</label>
         <form id="emailForm" class="flex flex-col sm:flex-row gap-2">
            <input id="userEmail" type="email" placeholder="votre.email@exemple.com" class="form-input flex-1 px-3 py-2" inputmode="email">
            <button id="submitEmailBtn" type="submit" class="btn btn-secondary whitespace-nowrap flex items-center justify-center gap-2">
              <svg id="emailSpinner" class="h-5 w-5 animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
              <span id="submitEmailText">Envoyer</span>
            </button>
         </form>
         <p id="emailStatus" class="text-xs text-gray-600 mt-1"></p>
      </div>
      
      <!-- Footer -->
      <div class="modal-footer">
          <button id="modalCompleteClose" class="btn btn-primary">
            Terminer
          </button>
      </div>
    </div>
  </div>


  <script>
    // Configuration globale charg√©e depuis le <head>
    const CONFIG = window.APP_CONFIG || {};

    // Micro-fonction de s√©lection
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    
    // Limite des notifications
    const MAX_TOASTS = 4;
    
    // Contexte Audio pour le son
    let audioCtx;
    function playSuccessSound() {
        try {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.05);
            oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
            oscillator.frequency.linearRampToValueAtTime(783.99, audioCtx.currentTime + 0.2); // G5
            oscillator.start(audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
            oscillator.stop(audioCtx.currentTime + 0.5);
        } catch (e) {
            console.warn("Impossible de jouer le son", e);
        }
    }


    /* =================================================================================== */
    /* ============================== NOTIFICATIONS (TOASTS) =========================== */
    /* =================================================================================== */
    
    function toast(msg, type = 'info', duration = 3500) {
      const w = $('#toasts');
      if (!w) return;
      while (w.children.length >= MAX_TOASTS) {
        const oldToast = w.firstElementChild;
        if (oldToast) { oldToast.remove(); }
      }
      const d = document.createElement('div');
      let c = 'bg-gray-700'; 
      if (type === 'ok') c = 'bg-green-600';
      if (type === 'warn') c = 'bg-amber-500';
      if (type === 'err') c = 'bg-red-600';
      d.className = `${c} text-white rounded-xl px-4 py-3 mb-2 shadow-lg text-sm font-medium transition-all duration-300 transform translate-x-full opacity-0`;
      d.textContent = msg;
      w.appendChild(d);
      requestAnimationFrame(() => {
          requestAnimationFrame(() => {
              d.classList.remove('translate-x-full', 'opacity-0');
              d.classList.add('translate-x-0', 'opacity-100');
          });
      });
      setTimeout(() => {
        d.classList.add('translate-x-full', 'opacity-0');
        d.addEventListener('transitionend', () => d.remove(), { once: true });
      }, duration);
    }

    /* =================================================================================== */
    /* ============================= GESTION DU LOCAL STORAGE ========================== */
    /* =================================================================================== */
    const LS_KEYS = {
      META: 'chops_voiceform_meta',
      STATUS_PREFIX: 'chops_voiceform_status_'
    };
    function saveMeta(meta) {
      try { localStorage.setItem(LS_KEYS.META, JSON.stringify(meta)); } 
      catch (e) { console.error("Erreur sauvegarde localStorage (meta):", e); toast("Impossible de sauvegarder le profil.", "err"); }
    }
    function loadMeta() {
      try { return JSON.parse(localStorage.getItem(LS_KEYS.META) || '{}'); } 
      catch (e) { console.error("Erreur chargement localStorage (meta):", e); return {}; }
    }
    function saveStatus(studentId, status) {
      if (!studentId) return;
      try { localStorage.setItem(LS_KEYS.STATUS_PREFIX + studentId, JSON.stringify(status)); } 
      catch (e) { console.error("Erreur sauvegarde localStorage (status):", e); toast("Impossible de sauvegarder la progression.", "err"); }
    }
    function loadStatus(studentId) {
      if (!studentId) return {};
      try { return JSON.parse(localStorage.getItem(LS_KEYS.STATUS_PREFIX + studentId) || '{}'); } 
      catch (e) { console.error("Erreur chargement localStorage (status):", e); return {}; }
    }
    
    /* =================================================================================== */
    /* =========================== LOGIQUE D'APPLICATION PRINCIPALE ====================== */
    /* =================================================================================== */

    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM Charg√©, initialisation...");

      // --- S√©lecteurs principaux ---
      const profileModal = $('#profileModal');
      const metaForm = $('#metaForm');
      const saveProfileBtn = $('#saveProfileBtn');
      const editProfileBtn = $('#editProfileBtn');
      const mainContent = $('#mainContent');
      const cardsGrid = $('#cardsGrid');
      const recordModal = $('#recordModal');
      const modalClose = $('#modalClose');
      const statusEl = $('#status');
      const floatingProgress = $('#floatingProgress');
      const progressText = $('#progressText');
      const progressPct = $('#progressPct');
      const progressBar = $('#progressBar');
      const profileSpinner = $('#profileSpinner'); 
      const completionModal = $('#completionModal');
      const modalCompleteClose = $('#modalCompleteClose');
      const emailForm = $('#emailForm');
      const submitEmailBtn = $('#submitEmailBtn');
      const userEmail = $('#userEmail');
      const emailStatus = $('#emailStatus');
      const emailSpinner = $('#emailSpinner');
      const submitEmailText = $('#submitEmailText');
      
      // --- V√©rification de l'UI ---
      if (!profileModal || !metaForm || !saveProfileBtn || !editProfileBtn || !mainContent || !cardsGrid || 
          !recordModal || !modalClose || !statusEl || !floatingProgress || !progressText || !progressPct || 
          !progressBar || !profileSpinner || !completionModal || !modalCompleteClose || !emailForm || 
          !submitEmailBtn || !userEmail || !emailStatus || !emailSpinner || !submitEmailText) {
          console.error("√âl√©ments UI principaux manquants ! V√©rifiez les IDs dans le HTML.");
          toast("Erreur critique: Interface incompl√®te.", "err");
          return;
      }

      // --- √âtat de l'application ---
      let currentMeta = { studentCode: '', cohort: '', profile: 'etudiant', used: 'CHOPS_plus_CHOPi', consent: false };
      let currentStatus = {};
      let topics = [];
      let currentTopic = null;
      let lastTrigger = null;
      let sendingDebounce = false; 
      let currentAnimatedPct = 0;
      let isSubmittingProfile = false;

      // --- Branding ---
      try {
        const brandTitleText = CONFIG.BRAND.TITLE || "Feedback App";
        document.title = brandTitleText; 
        const brandTitleEl = $('#brandTitle');
        if (brandTitleEl) brandTitleEl.textContent = brandTitleText;
        if ($('#brandLogo')) $('#brandLogo').src = CONFIG.BRAND.LOGO_URL;
        if ($('#favicon')) $('#favicon').href = CONFIG.BRAND.FAVICON_URL;
      } catch (e) { console.error("Erreur configuration Branding:", e); }

      // --- FONCTION hhmmss ---
      function hhmmss(s) { const sec = Math.max(0, Math.floor(s)); return `${String(Math.floor(sec / 60)).padStart(2, '0')}:${String(sec % 60).padStart(2, '0')}`; }
      if ($('#timerWrap')) $('#timerWrap').textContent = `00:00 / ${hhmmss(CONFIG.LIMITS.MAX_SECONDS)}`;

      // --- Initialisation du profil ---
      function initProfile() {
        console.log("Initialisation du profil...");
        const meta = loadMeta();
        if (meta && meta.studentCode && meta.cohort && meta.profile && meta.used && meta.consent === true && meta.userFolderDriveId) {
          console.log("Profil valide (avec ID dossier) trouv√©:", meta);
          currentMeta = meta;
          $('#studentCode').value = meta.studentCode;
          $('#cohort').value = meta.cohort;
          $('#profile').value = meta.profile;
          $('#used').value = meta.used;
          $('#consent').checked = meta.consent;
          profileModal.classList.add('hidden');
          mainContent.classList.remove('opacity-0');
          editProfileBtn.classList.remove('hidden');
          currentStatus = loadStatus(currentMeta.studentCode);
          renderAllCards();
        } else {
          console.log("Profil invalide ou ID dossier manquant, affichage de la modale.");
          profileModal.classList.remove('hidden');
          mainContent.classList.add('opacity-0');
          editProfileBtn.classList.add('hidden');
          updateProgress();
        }
      }

      // --- Gestionnaire soumission formulaire profil ---
      metaForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isSubmittingProfile) return;
        isSubmittingProfile = true;
        saveProfileBtn.disabled = true;
        saveProfileBtn.classList.add('btn-disabled');
        profileSpinner.classList.remove('hidden');
        const studentCode = $('#studentCode').value.trim();
        const cohort = $('#cohort').value.trim();
        const consent = $('#consent').checked;
        const profile = $('#profile').value;
        const used = $('#used').value;
        if (!/^[A-Za-z0-9_\-]{1,32}$/.test(studentCode)) {
           toast('Identifiant invalide (lettres, chiffres, _, -).', 'warn');
           isSubmittingProfile = false; saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('btn-disabled'); profileSpinner.classList.add('hidden'); return;
        }
         if (cohort.length < 1) {
           toast('Contexte requis.', 'warn');
           isSubmittingProfile = false; saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('btn-disabled'); profileSpinner.classList.add('hidden'); return;
         }
        if (!consent) {
           toast('Consentement requis.', 'warn');
           isSubmittingProfile = false; saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('btn-disabled'); profileSpinner.classList.add('hidden'); return;
        }
        currentMeta = { studentCode, cohort, profile, used, consent: true };
        try {
          console.log('Appel ensureUserFolder...');
          const folderPayload = { action: "ensureUserFolder", studentCode, cohort, profile, used };
          const folderJson = await fetchGAS(CONFIG.WEBAPP_URL, folderPayload);
          if (folderJson.ok === false) { throw new Error(folderJson.error || 'Erreur cr√©ation dossier.'); }
          if (!folderJson.userFolderDriveId) { throw new Error("R√©ponse backend invalide (ID dossier manquant)."); }
          currentMeta.userFolderDriveId = folderJson.userFolderDriveId;
          saveMeta(currentMeta); 
          currentStatus = loadStatus(currentMeta.studentCode); 
          console.log(`Dossier Drive OK. ID sauvegard√©: ${currentMeta.userFolderDriveId}`);
          profileModal.classList.add('hidden');
          renderAllCards();
          mainContent.classList.remove('opacity-0');
          editProfileBtn.classList.remove('hidden');
          toast('Profil enregistr√© !', 'ok');
        } catch (folderErr) {
          console.error('Erreur ensureUserFolder:', folderErr);
          toast(`Erreur config Drive : ${folderErr.message}.`, 'err');
        } finally {
          isSubmittingProfile = false;
          saveProfileBtn.disabled = false;
          saveProfileBtn.classList.remove('btn-disabled');
          profileSpinner.classList.add('hidden');
        }
      });

      // --- Bouton editProfile ---
      if (editProfileBtn) {
          editProfileBtn.addEventListener('click', () => {
            profileModal.classList.remove('hidden');
          });
      }
      
      // --- Listeners pour la modale de compl√©tion ---
      if(modalCompleteClose) {
          modalCompleteClose.addEventListener('click', () => {
              completionModal.classList.add('hidden');
              if (userEmail) userEmail.value = '';
              if (emailStatus) emailStatus.textContent = '';
              if (userEmail) userEmail.disabled = false;
              if (submitEmailBtn) submitEmailBtn.disabled = false;
              if (submitEmailBtn) submitEmailBtn.classList.remove('btn-disabled');
              if (emailSpinner) emailSpinner.classList.add('hidden');
              if (submitEmailText) submitEmailText.textContent = "Envoyer";
          });
      }
      
      if(emailForm) {
          emailForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const email = userEmail.value.trim();
              if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                  emailStatus.textContent = "Veuillez entrer un email valide.";
                  emailStatus.className = "text-xs text-red-600 mt-1";
                  return;
              }
              submitEmailBtn.disabled = true;
              submitEmailBtn.classList.add('btn-disabled');
              emailSpinner.classList.remove('hidden');
              submitEmailText.textContent = "Envoi...";
              emailStatus.textContent = "";
              try {
                  const payload = { action: "saveEmail", email: email, studentCode: currentMeta.studentCode || 'inconnu' };
                  const response = await fetchGAS(CONFIG.WEBAPP_URL, payload);
                  if (response.ok === false) { throw new Error(response.error || "Erreur inconnue"); }
                  emailStatus.textContent = "Merci ! Votre email est enregistr√©.";
                  emailStatus.className = "text-xs text-green-700 mt-1";
                  userEmail.disabled = true;
              } catch (err) {
                  console.error("Erreur sauvegarde email:", err);
                  emailStatus.textContent = `Erreur : ${err.message}`;
                  emailStatus.className = "text-xs text-red-600 mt-1";
                  submitEmailBtn.disabled = false;
                  submitEmailBtn.classList.remove('btn-disabled');
              } finally {
                  emailSpinner.classList.add('hidden');
                  if (!userEmail.disabled) { submitEmailText.textContent = "Envoyer"; } 
                  else { submitEmailText.textContent = "Envoy√©"; }
              }
          });
      }


      // --- Rendu des cartes et progression ---
      function getQuestion(profile, topic) {
        try {
           let effectiveProfile = profile || 'autre';
           // Adapte les profils si 'entrepreneur' ou 'freelance' ne sont pas dans QUESTIONS
           if (!CONFIG.QUESTIONS.hasOwnProperty(effectiveProfile)) {
               effectiveProfile = 'autre';
           }
           let questions = CONFIG.QUESTIONS[effectiveProfile];
           if (!questions || !questions.hasOwnProperty(topic)) {
               effectiveProfile = 'autre';
               questions = CONFIG.QUESTIONS['autre'];
           }
           if (!questions || !questions.hasOwnProperty(topic)) { return "[Question manquante]"; }
           return questions[topic];
        } catch (e) { console.error(`Erreur getQuestion(${profile}, ${topic})`, e); return "[Erreur question]"; }
      }
      
      function renderAllCards() {
        let effectiveProfile = currentMeta.profile || 'autre';
        // Adapte les profils si 'entrepreneur' ou 'freelance' ne sont pas dans QUESTIONS
        if (!CONFIG.QUESTIONS.hasOwnProperty(effectiveProfile)) {
            effectiveProfile = 'autre';
        }
        let profileQuestions = CONFIG.QUESTIONS[effectiveProfile];

        if (!profileQuestions || typeof profileQuestions !== 'object') {
            effectiveProfile = 'autre';
            profileQuestions = CONFIG.QUESTIONS['autre'];
        }
        if (!profileQuestions || typeof profileQuestions !== 'object') {
          topics = [];
          if (cardsGrid) cardsGrid.innerHTML = '<p class="text-red-600 text-center col-span-full">Erreur: Configuration des questions invalide.</p>';
          updateProgress(); 
          return;
        }
        topics = Object.keys(profileQuestions);
        if (topics.length === 0) {
           if (cardsGrid) cardsGrid.innerHTML = '<p class="text-center col-span-full">Aucune question configur√©e.</p>';
        } else {
           if (cardsGrid) cardsGrid.innerHTML = ''; 
           topics.forEach(topic => {
             const entry = currentStatus[topic];
             const done = !!entry?.done;
             const sending = !!entry?.sending;
             const failed = !!entry?.failed;
             const questionText = getQuestion(effectiveProfile, topic);
             const card = document.createElement('button');
             card.type = 'button';
             card.dataset.topic = topic;
             card.className = `glass-bubble w-full text-left p-5 space-y-3 transition duration-200 hover:shadow-lg hover:-translate-y-1 
                              ${done ? 'opacity-70 hover:opacity-100' : ''} 
                              ${sending ? 'opacity-50 cursor-not-allowed' : ''}
                              ${failed ? 'border-red-400 hover:border-red-500' : ''}`;
             if (sending) card.disabled = true; 
             let statusBadge = '';
             if (sending) {
                 statusBadge = `<span class="px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 text-xs font-medium flex items-center gap-1">
                                 <svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                                 Envoi...
                              </span>`;
             } else if (failed) {
                 statusBadge = `<span class="px-2 py-0.5 rounded-full bg-red-100 text-red-700 text-xs font-medium flex items-center gap-1">
                                 <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15h.006a1.75 1.75 0 001.746-1.63l-.46-2.065a.25.25 0 01.244-.305H13a.75.75 0 000-1.5H9z" clip-rule="evenodd" /></svg>
                                 √âchec
                               </span>`;
             } else if (done) {
                 statusBadge = `<span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-xs font-medium">R√©pondu</span>`;
             } else {
                 statusBadge = `<span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 text-xs font-medium">√Ä faire</span>`;
             }
             card.innerHTML = `
               <div class="flex items-center justify-between">
                 <span class="flex items-center gap-2 text-sm font-semibold text-indigo-700">
                   <img src="${CONFIG.BRAND.MARK_URL}" alt="" class="h-5 w-5">
                   ${topic.charAt(0).toUpperCase() + topic.slice(1)} 
                 </span>
                 ${statusBadge}
               </div>
               <p class="text-sm text-gray-800">${questionText}</p>
               ${done && entry.at ? `<p class="text-xs text-gray-500 pt-2">R√©pondu le ${new Date(entry.at).toLocaleDateString()}</p>` : ''}
               ${failed ? `<p class="text-xs text-red-600 pt-2">L'envoi a √©chou√©. Cliquez pour r√©essayer.</p>` : ''}
             `;
             card.addEventListener('click', () => openModal(topic, card));
             if (cardsGrid) cardsGrid.appendChild(card);
           });
        }
        updateProgress();
      }

      function updateProgress() {
        const validTopics = Array.isArray(topics) ? topics : []; 
        const done = validTopics.filter(t => !!currentStatus[t]?.done).length;
        const total = validTopics.length; 
        const pct = (total > 0) ? Math.round((done / total) * 100) : 0;
        if (progressText) progressText.textContent = `${done}/${total} compl√©t√©es`;
        animateCounter(progressPct, currentAnimatedPct, pct, '%');
        currentAnimatedPct = pct;
        if (progressBar) progressBar.style.width = `${pct}%`;
      }
      
      function animateCounter(el, from, to, suffix = '') {
         if (!el) return;
        if (from === to) { el.textContent = `${to}${suffix}`; return; }
        const duration = 400; const frameRate = 1000 / 60;
        const totalFrames = Math.round(duration / frameRate);
        const diff = to - from;
        let frame = 0;
        let animationFrameId;
        function step() {
          frame++;
          const progress = 1 - Math.pow(1 - (frame / totalFrames), 2);
          const currentVal = from + (diff * progress);
          el.textContent = `${Math.round(currentVal)}${suffix}`;
          if (frame < totalFrames) {
             animationFrameId = requestAnimationFrame(step);
          } else {
             el.textContent = `${to}${suffix}`;
          }
        }
        cancelAnimationFrame(animationFrameId);
        animationFrameId = requestAnimationFrame(step);
      }
      
      // ------------------------------------
      // Logique de la Modale d'Enregistrement
      // ------------------------------------
      
      const btnRecord = $('#btnRecord');
      const btnPause = $('#btnPause');
      const btnResume = $('#btnResume');
      const btnStop = $('#btnStop');
      const btnReRecord = $('#btnReRecord');
      const btnSend = $('#btnSend');
      const meterBar = $('#meter');
      const timerEl = $('#timer');
      const timerWrap = $('#timerWrap');
      const player = $('#player');
      const previewWrap = $('#previewWrap');
      const fileInfo = $('#fileInfo');
      let mediaStream, mediaRecorder, audioChunks = [], audioBlob = null, audioUrl = null, mimeType = 'audio/webm';
      let startedAt = 0, pausedAt = 0, totalPausedTime = 0;
      let timerInterval = null;
      let analyser, dataArray; 
      
      function openModal(topic, trigger) {
        if (currentStatus[topic]?.sending) {
           toast('Envoi en cours pour ce sujet...', 'warn');
           return; 
        }
        if (currentStatus[topic]?.failed) {
            delete currentStatus[topic].failed;
            renderAllCards(); 
        }
        if (!currentMeta.consent || !currentMeta.studentCode || !currentMeta.cohort || !currentMeta.userFolderDriveId) {
           toast('Veuillez valider votre profil.', 'warn');
           profileModal.classList.remove('hidden'); 
           return;
        }
        currentTopic = topic;
        lastTrigger = trigger || null;
        $('#modalTheme').textContent = topic.charAt(0).toUpperCase() + topic.slice(1);
        $('#modalTitle').textContent = getQuestion(currentMeta.profile, topic);
        resetRecording(true); 
        recordModal.classList.remove('hidden');
        btnRecord.focus(); 
      }
      function closeModal() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') { mediaRecorder.stop(); }
        mediaStream?.getTracks().forEach(track => track.stop());
        recordModal.classList.add('hidden'); 
        if (lastTrigger) lastTrigger.focus();
        currentTopic = null; 
      }
      if (modalClose) modalClose.addEventListener('click', closeModal);
      if (recordModal) recordModal.addEventListener('click', (e) => { if (e.target === recordModal) closeModal(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && recordModal && !recordModal.classList.contains('hidden')) { closeModal(); } });
      function setStatus(t) { if (statusEl) statusEl.textContent = t; }
      function updateSendState() {
        const canSend = currentMeta.consent && !!audioBlob && !sendingDebounce;
        if (btnSend) { btnSend.disabled = !canSend; btnSend.classList.toggle('btn-disabled', !canSend); }
      }
      function resetRecording(inModal = false) {
        mediaStream?.getTracks().forEach(t => t.stop()); mediaStream = null;
        if (mediaRecorder && mediaRecorder.state !== 'inactive') { try { mediaRecorder.stop(); } catch(e) {} }
        mediaRecorder = null;
        clearInterval(timerInterval); timerInterval = null;
        audioChunks = []; audioBlob = null;
        if (audioUrl) { URL.revokeObjectURL(audioUrl); audioUrl = null; }
        startedAt = 0; pausedAt = 0; totalPausedTime = 0;
        if (inModal) {
          if(previewWrap) previewWrap.classList.add('hidden');
          if ($('#controlsWrap')) $('#controlsWrap').classList.remove('hidden');
          const maxTime = hhmmss(CONFIG.LIMITS.MAX_SECONDS);
          if(timerEl) timerEl.textContent = '00:00';
          if(timerWrap) timerWrap.textContent = `00:00 / ${maxTime}`;
          if(meterBar) meterBar.style.width = '0%';
          if(btnRecord) btnRecord.classList.remove('hidden');
          if(btnPause) btnPause.classList.add('hidden');
          if(btnResume) btnResume.classList.add('hidden');
          if(btnStop) btnStop.classList.add('hidden');
          if(btnStop) btnStop.disabled = true;
          if(btnRecord) btnRecord.disabled = false;
          setStatus('Pr√™t');
          updateSendState();
        }
      }

      // --- Logique d'enregistrement ---
      if(btnRecord) btnRecord.addEventListener('click', startRecording);
      if(btnPause) btnPause.addEventListener('click', pauseRecording);
      if(btnResume) btnResume.addEventListener('click', resumeRecording);
      if(btnStop) btnStop.addEventListener('click', stopRecording);
      if(btnReRecord) btnReRecord.addEventListener('click', () => resetRecording(true));
      async function startRecording() {
        resetRecording(true);
        try {
          mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { noiseSuppression: true, echoCancellation: true } });
        } catch (err) {
          let errorMsg = 'Erreur: Micro refus√©/non trouv√©.';
          if (err.name === 'NotAllowedError') errorMsg = 'Autorisation micro requise.';
          else if (err.name === 'NotFoundError') errorMsg = 'Aucun micro trouv√©.';
          toast(errorMsg, 'err'); setStatus('Erreur micro'); return;
        }
        try {
          if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
          if (audioCtx.state === 'suspended') { audioCtx.resume().catch(e => {}); }
          document.addEventListener("visibilitychange", () => { if (!audioCtx || audioCtx.state === 'closed') return; if (document.visibilityState === 'visible') { audioCtx.resume().catch(e => {}); } });
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 256; dataArray = new Uint8Array(analyser.frequencyBinCount);
          const source = audioCtx.createMediaStreamSource(mediaStream);
          source.connect(analyser);
          const preferred = ["audio/webm;codecs=opus", "audio/webm", "audio/mp4", "audio/ogg;codecs=opus"];
          mimeType = preferred.find(t => MediaRecorder.isTypeSupported?.(t)) || 'audio/webm';
          mediaRecorder = new MediaRecorder(mediaStream, { mimeType });
          mediaRecorder.ondataavailable = e => { if (e.data?.size > 0) audioChunks.push(e.data); };
          mediaRecorder.onstart = () => {
            startedAt = Date.now(); totalPausedTime = 0;
            setStatus('Enregistrement en cours‚Ä¶'); toast('Enregistrement d√©marr√©...');
            btnRecord.classList.add('hidden');
            btnPause.classList.remove('hidden');
            btnResume.classList.add('hidden');
            btnStop.classList.remove('hidden');
            btnStop.disabled = false;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
              const elapsedSeconds = (Date.now() - startedAt - totalPausedTime) / 1000;
              const sec = Math.min(CONFIG.LIMITS.MAX_SECONDS, elapsedSeconds);
              const maxTime = hhmmss(CONFIG.LIMITS.MAX_SECONDS);
              if(timerEl) timerEl.textContent = hhmmss(sec);
              if(timerWrap) timerWrap.textContent = `${hhmmss(sec)} / ${maxTime}`;
              if (sec >= CONFIG.LIMITS.MAX_SECONDS) { stopRecording(); toast(`Temps max (${maxTime}) atteint.`, 'warn'); }
              if (analyser && dataArray && meterBar) {
                analyser.getByteTimeDomainData(dataArray); let sum = 0;
                for (let i = 0; i < dataArray.length; i++) { const v = (dataArray[i] - 128) / 128; sum += v * v; }
                const rms = Math.sqrt(sum / dataArray.length);
                meterBar.style.width = Math.min(100, Math.floor(rms * 200)) + "%"; 
              }
            }, 80);
          };
          mediaRecorder.onstop = () => {
            clearInterval(timerInterval); timerInterval = null;
            if (meterBar) meterBar.style.width = '0%';
            audioBlob = new Blob(audioChunks, { type: mimeType });
            if (audioBlob.size > CONFIG.LIMITS.MAX_BYTES) { toast(`Fichier trop volumineux (> ${Math.round(CONFIG.LIMITS.MAX_BYTES / 1024 / 1024)} Mo).`, 'err'); resetRecording(true); return; }
            if (audioBlob.size < 1000) { toast('Enregistrement trop court.', 'warn'); resetRecording(true); return; }
            audioUrl = URL.createObjectURL(audioBlob);
            if(player) player.src = audioUrl;
            if(previewWrap) previewWrap.classList.remove('hidden');
            if ($('#controlsWrap')) $('#controlsWrap').classList.add('hidden');
            const durationText = (timerEl ? timerEl.textContent : hhmmss(0));
            if(fileInfo) fileInfo.textContent = `${mimeType}, ${(audioBlob.size / 1024).toFixed(1)} KB, dur√©e: ${durationText}`;
            setStatus('Pr√™t √† l‚Äôenvoi');
            updateSendState();
            mediaStream?.getTracks().forEach(t => t.stop()); mediaStream = null;
          };
          mediaRecorder.onerror = (event) => { console.error(`Erreur MediaRecorder: ${event.error.name}`, event.error); toast(`Erreur enregistrement: ${event.error.message}`, 'err'); setStatus('Erreur enregistrement'); resetRecording(true); };
          mediaRecorder.start();
        } catch (err) { console.error("Erreur init enregistrement:", err); toast("Impossible de d√©marrer l'enregistrement.", 'err'); setStatus('Erreur init'); resetRecording(true); }
      }
      function pauseRecording() {
        if (mediaRecorder?.state === 'recording') {
          mediaRecorder.pause(); pausedAt = Date.now();
          clearInterval(timerInterval); timerInterval = null;
          setStatus('En pause');
          if(btnPause) btnPause.classList.add('hidden'); if(btnResume) btnResume.classList.remove('hidden');
        }
      }
      function resumeRecording() {
        if (mediaRecorder?.state === 'paused') {
          mediaRecorder.resume();
          totalPausedTime += (Date.now() - pausedAt); pausedAt = 0;
          setStatus('Enregistrement en cours‚Ä¶');
          if(btnPause) btnPause.classList.remove('hidden'); if(btnResume) btnResume.classList.add('hidden');
          if (timerInterval) clearInterval(timerInterval);
          timerInterval = setInterval(() => {
            const elapsedSeconds = (Date.now() - startedAt - totalPausedTime) / 1000;
            const sec = Math.min(CONFIG.LIMITS.MAX_SECONDS, elapsedSeconds);
            const maxTime = hhmmss(CONFIG.LIMITS.MAX_SECONDS);
            if(timerEl) timerEl.textContent = hhmmss(sec);
            if(timerWrap) timerWrap.textContent = `${hhmmss(sec)} / ${maxTime}`;
            if (sec >= CONFIG.LIMITS.MAX_SECONDS) stopRecording();
            if (analyser && dataArray && meterBar) {
              analyser.getByteTimeDomainData(dataArray); let sum = 0;
              for(let i=0;i<dataArray.length;i++){ const v=(dataArray[i]-128)/128; sum+=v*v; }
              const rms=Math.sqrt(sum/dataArray.length);
              meterBar.style.width=Math.min(100,Math.floor(rms*200))+"%";
            }
          }, 80);
        }
      }
      function stopRecording() {
        if (mediaRecorder && (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused')) {
          mediaRecorder.stop(); toast('Enregistrement arr√™t√©.');
          if(btnRecord) btnRecord.classList.remove('hidden');
          if(btnPause) btnPause.classList.add('hidden');
          if(btnResume) btnResume.classList.add('hidden');
          if(btnStop) btnStop.classList.add('hidden');
          if(btnStop) btnStop.disabled = true;
          if(btnRecord) btnRecord.disabled = false;
        }
      }

      // ------------------------------------
      // Logique d'Envoi et API
      // ------------------------------------
      async function fetchGAS(url, payload) {
        if (!url || url.startsWith("REMPLACEZ_PAR") || !url.startsWith("https://script.google.com")) {
            throw new Error("Backend URL invalide ou non configur√©e.");
        }
        try {
          const response = await fetch(url, { method: 'POST', mode: 'cors', credentials: 'omit', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload), redirect: 'follow' });
          if (!response.ok) {
            let errorText = `Erreur r√©seau: ${response.statusText} (${response.status})`;
            try { const errJson = await response.json(); if (errJson?.error) errorText = `Erreur backend: ${errJson.error}`; } catch(e) {}
            throw new Error(errorText);
          }
          return response.json(); 
        } catch (err) { console.error("Erreur fetchGAS:", err); throw new Error("Communication serveur √©chou√©e."); }
      }
      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => {
            try { const base64 = reader.result.split(',')[1]; if (!base64) throw new Error("Conversion Base64 invalide."); resolve(base64); } catch (err) { reject(err); }
          };
          reader.onerror = reject; reader.readAsDataURL(blob);
        });
      }
      if(btnSend) btnSend.addEventListener('click', submitOne);
      async function submitOne() {
         if (sendingDebounce || !audioBlob) return;
         sendingDebounce = true;
         setStatus('Pr√©paration envoi...');
         updateSendState();
         try {
           const fileBase64 = await blobToBase64(audioBlob); 
           const [mm, ss] = timerEl ? timerEl.textContent.split(':').map(Number) : [0, 0];
           const durationSec = (mm * 60 + ss) || 0;
           const topicToUpdate = currentTopic;
           const payload = {
             action: "uploadAudio", ...currentMeta,
             topic: topicToUpdate, durationSec: durationSec, mimeType: mimeType,
             transcription: "[CLIENT_TRANSCRIPTION_DISABLED]",
             fileBase64: fileBase64, clientUA: navigator.userAgent
           };
           currentStatus[topicToUpdate] = { sending: true };
           renderAllCards(); 
           toast('Envoi de votre r√©ponse...');
           closeModal(); 
           runUploadTask(payload, topicToUpdate, durationSec);
         } catch (err) {
           console.error('Erreur pr√©paration submitOne:', err);
           toast(`Erreur pr√©paration : ${err.message}. R√©essayez.`, 'err');
           setStatus('Erreur pr√©paration');
           if (currentTopic) { delete currentStatus[currentTopic].sending; renderAllCards(); }
         } finally {
           sendingDebounce = false;
           updateSendState();
         }
      } 
      async function runUploadTask(payload, topic, durationSec) {
          const topicLabel = `"${topic.charAt(0).toUpperCase() + topic.slice(1)}"`;
          console.log(`[BG Task ${topic}] D√©marrage envoi...`);
          try {
              const jsonResult = await fetchGAS(CONFIG.WEBAPP_URL, payload);
              if (jsonResult.ok === false) { throw new Error(jsonResult.error || "Erreur inconnue du backend."); }
              console.log(`[BG Task ${topic}] Succ√®s.`);
              currentStatus[topic] = { done: true, at: new Date().toISOString(), durationSec: durationSec };
              saveStatus(currentMeta.studentCode, currentStatus);
              renderAllCards(); 
              toast(`R√©ponse pour ${topicLabel} envoy√©e !`, 'ok'); 
              const validTopics = Array.isArray(topics) ? topics : [];
              const done = validTopics.filter(t => !!currentStatus[t]?.done).length;
              const total = validTopics.length;
              if (total > 0 && done === total) {
                setTimeout(() => { showCompletionModal(); }, 1000); 
              }
          } catch (err) {
              console.error(`[BG Task ${topic}] √âchec:`, err);
              currentStatus[topic] = { failed: true }; 
              saveStatus(currentMeta.studentCode, currentStatus); 
              renderAllCards(); 
              toast(`Erreur pour ${topicLabel}: ${err.message}`, 'err');
          }
      }
      
      function showCompletionModal() {
          playSuccessSound();
          completionModal.classList.remove('hidden');
          modalCompleteClose.focus();
      }
      
      // --- D√©marrage ---
      initProfile(); 
      console.log("Initialisation termin√©e.");
      
    }); // Fin de DOMContentLoaded
  </script>
</body>
</html>
